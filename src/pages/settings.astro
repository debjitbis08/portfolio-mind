---
import Layout from "../layouts/Layout.astro";
import { validateSession } from "../lib/auth";

const session = await validateSession(Astro.request);

if (!session) {
  return Astro.redirect("/login");
}
---

<Layout title="Settings | Portfolio Mind">
  <main class="min-h-screen bg-base p-6 md:p-12">
    <div class="max-w-4xl mx-auto space-y-8">
      <!-- Header -->
      <header class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-text mb-2">Settings</h1>
          <p class="text-subtext0">
            Manage your investment profile and integrations
          </p>
        </div>
        <a
          href="/dashboard"
          class="px-4 py-2 bg-surface1 hover:bg-surface2 text-text rounded-lg transition-colors"
        >
          ‚Üê Back to Dashboard
        </a>
      </header>

      <!-- Settings Form -->
      <div class="space-y-6">
        <!-- Investment Profile -->
        <section class="bg-surface0 border border-surface1 rounded-2xl p-6">
          <h2 class="text-xl font-semibold text-lavender mb-4">
            Investment Profile
          </h2>
          <div class="space-y-4 max-w-md">
            <div>
              <label class="block text-sm text-subtext0 mb-2"
                >Available Funds for Investment</label
              >
              <div class="relative">
                <span class="absolute left-3 top-2 text-subtext0">‚Çπ</span>
                <input
                  type="number"
                  id="available-funds"
                  class="w-full bg-surface1 border border-surface1 rounded-lg py-2 pl-7 pr-3 text-text focus:outline-none focus:border-mauve transition-colors"
                  placeholder="0"
                />
              </div>
            </div>
          </div>
        </section>

        <!-- Integrations -->
        <section class="bg-surface0 border border-surface1 rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <h2 class="text-xl font-semibold text-peach">Integrations</h2>
            <span class="px-2 py-0.5 bg-surface1 text-xs rounded text-subtext0"
              >Secure</span
            >
          </div>

          <!-- Screener.in -->
          <div class="space-y-6">
            <div
              class="flex items-start gap-4 p-4 bg-surface1/30 rounded-xl border border-surface1/50"
            >
              <div
                class="w-10 h-10 rounded-lg bg-blue/10 flex items-center justify-center text-blue text-xl"
              >
                S
              </div>
              <div class="flex-1">
                <h3 class="font-medium text-text">Screener.in Automation</h3>
                <p class="text-sm text-subtext0 mt-1">
                  Connect your account to automatically import screens daily via
                  secure headless browser. Credentials are encrypted and stored
                  securely.
                </p>

                <!-- Credentials -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                  <div>
                    <label class="block text-xs text-subtext0 mb-1">Email</label
                    >
                    <input
                      type="email"
                      id="screener-email"
                      class="w-full bg-surface1 border border-surface1 rounded-lg px-3 py-2 text-text text-sm focus:outline-none focus:border-mauve"
                      placeholder="your@email.com"
                    />
                  </div>
                  <div>
                    <label class="block text-xs text-subtext0 mb-1"
                      >Password</label
                    >
                    <input
                      type="password"
                      id="screener-password"
                      class="w-full bg-surface1 border border-surface1 rounded-lg px-3 py-2 text-text text-sm focus:outline-none focus:border-mauve"
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                    <p
                      id="password-status"
                      class="text-xs text-green mt-1 hidden"
                    >
                      Password set ‚úì
                    </p>
                  </div>
                </div>

                <!-- Screen URLs -->
                <div class="mt-4">
                  <label class="block text-xs text-subtext0 mb-1"
                    >Screen URLs to Monitor</label
                  >
                  <div id="urls-container" class="space-y-2">
                    <!-- URL inputs will be added here -->
                    <div class="flex gap-2">
                      <input
                        type="url"
                        class="screener-url w-full bg-surface1 border border-surface1 rounded-lg px-3 py-2 text-text text-sm focus:outline-none focus:border-mauve"
                        placeholder="https://www.screener.in/screens/..."
                      />
                      <button
                        class="remove-url px-2 text-red hover:bg-red/10 rounded hidden"
                        >√ó</button
                      >
                    </div>
                  </div>
                  <button
                    id="add-url-btn"
                    class="mt-2 text-xs text-mauve hover:text-mauve/80 font-medium"
                  >
                    + Add another URL
                  </button>
                </div>

                <!-- Sync Now Button -->
                <div class="mt-6 pt-4 border-t border-surface1/50">
                  <div class="flex items-center gap-4">
                    <button
                      id="sync-screener-btn"
                      class="px-4 py-2 bg-blue/20 hover:bg-blue/30 text-blue font-medium rounded-lg transition-colors flex items-center gap-2"
                    >
                      <span id="sync-icon">‚Üª</span>
                      <span id="sync-text">Sync Now</span>
                    </button>
                    <span id="sync-status" class="text-sm text-subtext0"></span>
                  </div>
                  <p class="text-xs text-subtext0 mt-2">
                    Imports current screen results into your watchlist. Safe to
                    run once per day.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Symbol Mappings -->
        <section class="bg-surface0 border border-surface1 rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <h2 class="text-xl font-semibold text-mauve">Symbol Mappings</h2>
            <span class="px-2 py-0.5 bg-surface1 text-xs rounded text-subtext0"
              >Composite</span
            >
          </div>

          <div class="space-y-6">
            <p class="text-sm text-subtext0">
              Map platform-specific symbols (e.g., ICICI Direct, Groww) to
              standard trading symbols. Built-in mappings are shared with all
              users, while custom mappings are private to your database.
            </p>

            <!-- Built-in Mappings (Read-only) -->
            <div>
              <h3 class="text-sm font-medium text-text mb-3">
                Built-in Mappings
              </h3>
              <div
                id="built-in-mappings-list"
                class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"
              >
                <!-- Built-in mappings will be listed here -->
              </div>
            </div>

            <!-- Custom Mappings -->
            <div class="pt-4 border-t border-surface1/50">
              <h3 class="text-sm font-medium text-text mb-3">
                My Custom Mappings
              </h3>
              <div id="mappings-container" class="space-y-2">
                <!-- Mapping rows will be added here -->
              </div>
              <button
                id="add-mapping-btn"
                class="mt-3 text-xs text-mauve hover:text-mauve/80 font-medium"
              >
                + Add custom mapping
              </button>
            </div>
          </div>
        </section>

        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <h2 class="text-xl font-semibold text-green">AI Assistant</h2>
            <span class="px-2 py-0.5 bg-surface1 text-xs rounded text-subtext0"
              >Global Control</span
            >
          </div>
          <label
            class="relative inline-flex items-center cursor-pointer scale-110"
          >
            <input
              type="checkbox"
              id="ai-enabled-toggle"
              class="sr-only peer"
              checked
            />
            <div
              class="w-14 h-7 bg-surface1 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-subtext0 after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green peer-checked:after:bg-crust"
            >
            </div>
          </label>
        </div>

        <p class="text-sm text-subtext0 mb-6">
          Enable or disable AI features globally. When disabled, the AI will not
          analyze your portfolio or provide suggestions.
        </p>

        <div id="ai-tools-section" class="transition-opacity duration-300">
          <h3 class="text-sm font-medium text-text mb-4">
            Specific Tool Config
          </h3>
          <div id="tools-container" class="space-y-4">
            <!-- Tool cards will be populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Save Actions -->
      <div
        class="flex items-center justify-end gap-3 pt-4 border-t border-surface1"
      >
        <span id="save-status" class="text-sm"></span>
        <button
          id="save-settings-btn"
          class="px-6 py-2.5 bg-mauve hover:bg-mauve/90 text-crust font-medium rounded-xl transition-colors shadow-lg shadow-mauve/20"
        >
          Save Changes
        </button>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Elements
  const fundsInput = document.getElementById(
    "available-funds"
  ) as HTMLInputElement;
  const screenerEmailInput = document.getElementById(
    "screener-email"
  ) as HTMLInputElement;
  const screenerPasswordInput = document.getElementById(
    "screener-password"
  ) as HTMLInputElement;
  const passwordStatus = document.getElementById("password-status");
  const urlsContainer = document.getElementById("urls-container");
  const addUrlBtn = document.getElementById("add-url-btn");
  const builtInMappingsList = document.getElementById("built-in-mappings-list");
  const mappingsContainer = document.getElementById("mappings-container");
  const addMappingBtn = document.getElementById("add-mapping-btn");
  const saveBtn = document.getElementById(
    "save-settings-btn"
  ) as HTMLButtonElement;
  const statusEl = document.getElementById("save-status");
  const toolsContainer = document.getElementById("tools-container");
  const aiEnabledToggle = document.getElementById(
    "ai-enabled-toggle"
  ) as HTMLInputElement;
  const aiToolsSection = document.getElementById("ai-tools-section");

  // Tool metadata for display
  const TOOL_METADATA: Record<
    string,
    { label: string; description: string; icon: string }
  > = {
    browse_screener: {
      label: "Browse Screener",
      description: "Fetch stocks from screener.in screens",
      icon: "üìä",
    },
    get_stock_thesis: {
      label: "Stock Thesis",
      description: "Get investment thesis from ValuePickr",
      icon: "üìù",
    },
    get_technicals: {
      label: "Technicals",
      description: "Get RSI, SMA50, SMA200 indicators",
      icon: "üìà",
    },
    check_wait_zone: {
      label: "Wait Zone Check",
      description: "Check if stock is overextended",
      icon: "‚è∏Ô∏è",
    },
    get_stock_news: {
      label: "Stock News",
      description: "Get recent news from Google News",
      icon: "üì∞",
    },
    get_reddit_sentiment: {
      label: "Reddit Sentiment",
      description: "Get retail sentiment as contrarian indicator",
      icon: "üî¥",
    },
    get_previous_suggestions: {
      label: "Previous Suggestions",
      description: "Review past AI recommendations and decisions",
      icon: "üîÆ",
    },
    get_commodity_prices: {
      label: "Commodity Prices",
      description: "Get gold, silver prices in INR per gram",
      icon: "üí∞",
    },
    get_company_knowledge: {
      label: "Company Knowledge",
      description: "Access user research notes and saved links",
      icon: "üóÇÔ∏è",
    },
    get_recent_trades: {
      label: "Recent Trades",
      description: "View recent buy/sell transaction history",
      icon: "üíπ",
    },
    get_financials: {
      label: "Financials",
      description: "Get financials from cache",
      icon: "üìä",
    },
  };

  // Current tool config state
  let currentToolConfig: Record<string, any> = {};

  // Load Settings
  async function loadSettings() {
    try {
      const res = await fetch("/api/settings");
      const { settings } = await res.json();

      if (settings) {
        if (settings.available_funds)
          fundsInput.value = settings.available_funds;
        if (settings.screener_email)
          screenerEmailInput.value = settings.screener_email;
        if (settings.has_screener_password) {
          screenerPasswordInput.placeholder =
            "Encrypted & Saved (Enter to update)";
          passwordStatus?.classList.remove("hidden");
        }

        // Populate URLs
        if (settings.screener_urls && settings.screener_urls.length > 0) {
          urlsContainer!.innerHTML = "";
          settings.screener_urls.forEach((url: string) => addUrlRow(url));
        }

        // Populate Built-in Mappings
        if (settings.built_in_mappings) {
          builtInMappingsList!.innerHTML = "";
          Object.entries(settings.built_in_mappings).forEach(([from, to]) => {
            const span = document.createElement("div");
            span.className =
              "px-2 py-1 bg-surface1/50 rounded text-xs text-subtext0 border border-surface1/30 flex justify-between";
            span.innerHTML = `<span>${from}</span> <span class="text-mauve">‚Üí</span> <span>${to}</span>`;
            builtInMappingsList?.appendChild(span);
          });
        }

        // Populate User Mappings
        if (settings.user_mappings) {
          mappingsContainer!.innerHTML = "";
          Object.entries(settings.user_mappings).forEach(([from, to]) =>
            addMappingRow(from, to as string)
          );
        }

        // Populate Tool Config
        if (settings.tool_config) {
          currentToolConfig = settings.tool_config;
          renderToolCards();
        }

        // Set AI Enabled toggle
        if (settings.ai_enabled !== undefined) {
          aiEnabledToggle.checked = settings.ai_enabled;
          updateAIVisibility();
        }
      }
    } catch (err) {
      console.error("Failed to load settings:", err);
    }
  }

  function addUrlRow(value = "") {
    const div = document.createElement("div");
    div.className = "flex gap-2";
    div.innerHTML = `
      <input
        type="url"
        class="screener-url w-full bg-surface1 border border-surface1 rounded-lg px-3 py-2 text-text text-sm focus:outline-none focus:border-mauve"
        placeholder="https://www.screener.in/screens/..."
        value="${value}"
      />
      <button class="remove-url px-2 text-red hover:bg-red/10 rounded">√ó</button>
    `;
    urlsContainer?.appendChild(div);

    // Add remove handler
    div.querySelector(".remove-url")?.addEventListener("click", () => {
      div.remove();
    });
  }

  function addMappingRow(from = "", to = "") {
    const div = document.createElement("div");
    div.className = "flex gap-2";
    div.innerHTML = `
      <input
        type="text"
        class="mapping-from w-1/2 bg-surface1 border border-surface1 rounded-lg px-3 py-2 text-text text-sm focus:outline-none focus:border-mauve"
        placeholder="Platform Symbol (e.g. GODAWARIP)"
        value="${from}"
      />
      <div class="flex items-center text-subtext0">‚Üí</div>
      <input
        type="text"
        class="mapping-to w-1/2 bg-surface1 border border-surface1 rounded-lg px-3 py-2 text-text text-sm focus:outline-none focus:border-mauve"
        placeholder="Trading Symbol (e.g. GPIL)"
        value="${to}"
      />
      <button class="remove-mapping px-2 text-red hover:bg-red/10 rounded">√ó</button>
    `;
    mappingsContainer?.appendChild(div);

    div.querySelector(".remove-mapping")?.addEventListener("click", () => {
      div.remove();
    });
  }

  // Render tool configuration cards
  function renderToolCards() {
    if (!toolsContainer) return;
    toolsContainer.innerHTML = "";

    for (const [toolName, config] of Object.entries(currentToolConfig)) {
      const meta = TOOL_METADATA[toolName] || {
        label: toolName,
        description: "",
        icon: "üîß",
      };
      const enabled = config.enabled !== false;

      const card = document.createElement("div");
      card.className = `p-4 rounded-xl border transition-all ${
        enabled
          ? "bg-surface1/30 border-surface1/50"
          : "bg-surface1/10 border-surface1/20 opacity-60"
      }`;
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-xl">${meta.icon}</span>
            <div>
              <h3 class="font-medium text-text">${meta.label}</h3>
              <p class="text-xs text-subtext0">${meta.description}</p>
            </div>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" class="sr-only peer tool-toggle" data-tool="${toolName}" ${enabled ? "checked" : ""}>
            <div class="w-11 h-6 bg-surface1 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-subtext0 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green peer-checked:after:bg-crust"></div>
          </label>
        </div>
      `;
      toolsContainer.appendChild(card);

      // Add toggle handler
      const toggle = card.querySelector(".tool-toggle") as HTMLInputElement;
      toggle?.addEventListener("change", () => {
        currentToolConfig[toolName].enabled = toggle.checked;
        renderToolCards();
      });
    }
  }

  // Event Listeners
  aiEnabledToggle?.addEventListener("change", () => {
    updateAIVisibility();
  });

  function updateAIVisibility() {
    if (aiToolsSection) {
      if (aiEnabledToggle.checked) {
        aiToolsSection.classList.remove("opacity-40", "pointer-events-none");
      } else {
        aiToolsSection.classList.add("opacity-40", "pointer-events-none");
      }
    }
  }

  addUrlBtn?.addEventListener("click", () => addUrlRow());
  addMappingBtn?.addEventListener("click", () => addMappingRow());

  saveBtn?.addEventListener("click", async () => {
    saveBtn.disabled = true;
    saveBtn.textContent = "Saving...";
    statusEl!.textContent = "";

    // Gather URLS
    const urlInputs = document.querySelectorAll(
      ".screener-url"
    ) as NodeListOf<HTMLInputElement>;
    const urls = Array.from(urlInputs)
      .map((input) => input.value.trim())
      .filter((url) => url.length > 0);

    const payload: any = {
      available_funds: parseFloat(fundsInput.value) || 0,
      screener_email: screenerEmailInput.value,
      screener_urls: urls,
    };

    if (screenerPasswordInput.value) {
      payload.screener_password = screenerPasswordInput.value;
    }

    // Gather Mappings
    const mappingRows = document.querySelectorAll("#mappings-container > div");
    const userMappings: Record<string, string> = {};
    mappingRows.forEach((row) => {
      const from = (
        row.querySelector(".mapping-from") as HTMLInputElement
      ).value.trim();
      const to = (
        row.querySelector(".mapping-to") as HTMLInputElement
      ).value.trim();
      if (from && to) {
        userMappings[from] = to;
      }
    });
    payload.user_mappings = userMappings;

    // Add tool config
    payload.tool_config = currentToolConfig;
    payload.ai_enabled = aiEnabledToggle.checked;

    try {
      const res = await fetch("/api/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        statusEl!.className = "text-sm text-green mr-2";
        statusEl!.textContent = "Settings saved successfully ‚úì";

        if (payload.screener_password) {
          screenerPasswordInput.value = "";
          screenerPasswordInput.placeholder =
            "Encrypted & Saved (Enter to update)";
          passwordStatus?.classList.remove("hidden");
        }
        setTimeout(() => {
          statusEl!.textContent = "";
        }, 3000);
      } else {
        throw new Error("Failed to save");
      }
    } catch (err) {
      statusEl!.className = "text-sm text-red mr-2";
      statusEl!.textContent = "Failed to save settings";
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = "Save Changes";
    }
  });

  // Sync Screener Button
  const syncBtn = document.getElementById(
    "sync-screener-btn"
  ) as HTMLButtonElement;
  const syncIcon = document.getElementById("sync-icon");
  const syncText = document.getElementById("sync-text");
  const syncStatus = document.getElementById("sync-status");

  syncBtn?.addEventListener("click", async () => {
    // Get current values
    const email = screenerEmailInput.value.trim();
    const password = screenerPasswordInput.value.trim();
    const urlInputs = document.querySelectorAll(
      ".screener-url"
    ) as NodeListOf<HTMLInputElement>;
    const urls = Array.from(urlInputs)
      .map((input) => input.value.trim())
      .filter((url) => url.length > 0);

    if (!email) {
      syncStatus!.className = "text-sm text-red";
      syncStatus!.textContent = "Please enter screener email first";
      return;
    }

    if (urls.length === 0) {
      syncStatus!.className = "text-sm text-red";
      syncStatus!.textContent = "Please add at least one screen URL";
      return;
    }

    // Check if we need a password (either entered or already saved)
    const hasPassword =
      password || passwordStatus?.classList.contains("hidden") === false;
    if (!hasPassword && !password) {
      syncStatus!.className = "text-sm text-yellow";
      syncStatus!.textContent = "Password required for first sync";
      return;
    }

    // Start sync
    syncBtn.disabled = true;
    syncIcon!.textContent = "‚è≥";
    syncIcon!.classList.add("animate-spin");
    syncText!.textContent = "Syncing...";
    syncStatus!.className = "text-sm text-subtext0";
    syncStatus!.textContent = `Logging in and processing ${urls.length} screen(s)...`;

    try {
      // Send all URLs in a single request - login happens once
      const res = await fetch("/api/integrations/screener/import", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email,
          password: password || undefined,
          screenUrls: urls, // Send all URLs at once
        }),
      });

      const data = await res.json();

      // Done
      syncBtn.disabled = false;
      syncIcon!.classList.remove("animate-spin");
      syncIcon!.textContent = "‚Üª";
      syncText!.textContent = "Sync Now";

      if (res.ok && data.success) {
        syncStatus!.className = "text-sm text-green";
        syncStatus!.textContent = `‚úì Imported ${data.imported} stocks to watchlist`;
      } else {
        syncStatus!.className = "text-sm text-red";
        syncStatus!.textContent = data.error || "Sync failed";
      }
    } catch (err) {
      syncBtn.disabled = false;
      syncIcon!.classList.remove("animate-spin");
      syncIcon!.textContent = "‚Üª";
      syncText!.textContent = "Sync Now";
      syncStatus!.className = "text-sm text-red";
      syncStatus!.textContent = "Network error - please try again";
    }

    // Clear status after delay
    setTimeout(() => {
      syncStatus!.textContent = "";
    }, 5000);
  });

  // Initial load
  loadSettings();
</script>
