---
import Layout from "../layouts/Layout.astro";
import { validateSession } from "../lib/auth";
import ActionNotes from "../components/notes/ActionNotes";
import CompanyNotes from "../components/notes/CompanyNotes";
import ResearchList from "../components/research/ResearchList";
import GlobalSearch from "../components/common/GlobalSearch";

// Check auth on server side
const session = await validateSession(Astro.request);

// Redirect if not logged in
if (!session) {
  return Astro.redirect("/login");
}
---

<Layout title="Dashboard - Portfolio Mind">
  <div class="min-h-screen p-4 md:p-8">
    <!-- Header -->
    <header class="max-w-6xl mx-auto flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-mauve">Portfolio Mind</h1>
        <div class="flex items-center gap-2">
          <p class="text-sm text-subtext0">Single User Mode</p>
          <span
            id="ai-status-badge"
            class="hidden px-2 py-0.5 bg-red/20 text-red text-[10px] uppercase font-bold rounded tracking-wider border border-red/30"
            >AI Disabled</span
          >
        </div>
      </div>
      <div class="flex items-center gap-2">
        <GlobalSearch client:load />
        <button
          id="refresh-btn"
          class="px-4 py-2 bg-surface1 hover:bg-surface2 text-subtext1 rounded-lg transition-colors"
        >
          Refresh
        </button>
        <a
          href="/settings"
          class="px-4 py-2 bg-surface1 hover:bg-surface2 text-subtext1 rounded-lg transition-colors flex items-center gap-2"
        >
          ‚öôÔ∏è Settings
        </a>
        <button
          id="logout-btn"
          class="px-4 py-2 bg-surface1 hover:bg-surface2 text-subtext1 rounded-lg transition-colors"
        >
          Logout
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto space-y-6">
      <!-- Summary Card -->
      <section id="summary-card" class="border border-surface1 rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg text-subtext0">
            Holdings <span id="holdings-count" class="text-text">(0)</span>
          </h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <p class="text-sm text-subtext0">Current value</p>
            <p id="current-value" class="text-3xl font-bold text-text">‚Çπ0</p>
          </div>
          <div>
            <p class="text-sm text-subtext0">Invested value</p>
            <p id="invested-value" class="text-xl text-subtext1">‚Çπ0</p>
          </div>
          <div>
            <p class="text-sm text-subtext0">Total returns</p>
            <p id="total-returns" class="text-xl font-semibold text-green">
              ‚Çπ0 (0%)
            </p>
          </div>
        </div>
      </section>

      <!-- Holdings Table -->
      <section
        class="bg-surface0 border border-surface1 rounded-2xl overflow-hidden"
      >
        <div class="p-4 border-b border-surface1 flex gap-2">
          <button
            id="refresh-tech-btn"
            class="px-3 py-1 text-sm bg-surface1 hover:bg-surface2 text-subtext1 rounded-lg transition-colors"
          >
            ‚ö° Refresh Technical Data
          </button>
          <span id="tech-status" class="text-sm text-subtext0 self-center"
          ></span>
        </div>
        <div id="holdings-loading" class="p-6 text-center text-subtext0">
          Loading holdings...
        </div>
        <table id="holdings-table" class="w-full hidden">
          <thead class="border-b border-surface1">
            <tr class="text-left text-sm text-subtext0">
              <th class="p-4">Company</th>
              <th class="p-4 text-center">Technical</th>
              <th class="p-4 text-right">Market price</th>
              <th class="p-4 text-right">Returns (%)</th>
              <th class="p-4 text-right">Current (Invested)</th>
              <th class="p-4 text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="holdings-body" class="divide-y divide-surface1"> </tbody>
        </table>
      </section>

      <!-- AI Discovery Section -->
      <section
        class="bg-surface0 border border-surface1 rounded-2xl overflow-hidden"
      >
        <div
          class="p-4 border-b border-surface1 flex items-center justify-between flex-wrap gap-2"
        >
          <div class="flex items-center gap-3">
            <h2 class="text-lg text-subtext0">ü§ñ AI Discovery</h2>
            <button
              id="run-discovery-btn"
              class="px-4 py-1.5 bg-mauve hover:bg-mauve/90 text-crust font-medium text-sm rounded-lg transition-colors"
            >
              Run Discovery Cycle
            </button>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-subtext0">Show:</span>
            <button
              id="filter-pending"
              class="suggestion-filter px-2 py-1 text-xs bg-mauve/20 text-mauve rounded transition-colors"
              data-status="pending"
            >
              Pending
            </button>
            <button
              id="filter-history"
              class="suggestion-filter px-2 py-1 text-xs bg-surface2 text-subtext0 hover:bg-surface1 rounded transition-colors"
              data-status="history"
            >
              History
            </button>
            <span id="discovery-status" class="text-sm text-subtext0 ml-2"
            ></span>
          </div>
        </div>

        <!-- Progress bar (hidden by default) -->
        <div
          id="discovery-progress"
          class="hidden px-4 py-3 border-b border-surface1"
        >
          <div class="flex justify-between text-xs text-subtext0 mb-1">
            <span id="progress-message">Starting...</span>
            <span id="progress-percent">0%</span>
          </div>
          <div class="h-2 bg-surface2 rounded-full overflow-hidden">
            <div
              id="progress-bar"
              class="h-full bg-mauve transition-all duration-300"
              style="width: 0%"
            >
            </div>
          </div>
        </div>

        <div id="suggestions-container" class="divide-y divide-surface1 p-6">
          <div id="suggestions-loading" class="p-6 text-center text-subtext0">
            Click "Run Discovery Cycle" to analyze your portfolio with AI
          </div>
          <div id="ai-disabled-message" class="hidden p-8 text-center">
            <div class="text-4xl mb-3">ü§ñüí§</div>
            <h3 class="text-lg font-medium text-text mb-1">
              AI Assistant is Disabled
            </h3>
            <p class="text-subtext0 text-sm max-w-sm mx-auto">
              You've disabled AI features in settings. Enable the AI Assistant
              to get automated investment suggestions and portfolio analysis.
            </p>
            <a
              href="/settings"
              class="inline-block mt-4 text-mauve hover:underline text-sm font-medium"
            >
              Go to Settings ‚Üí
            </a>
          </div>
          <div id="suggestions-list" class="hidden"></div>
        </div>
      </section>

      <!-- Commodity Holdings Section (Collapsed) -->
      <details class="bg-surface0 border border-surface1 rounded-2xl">
        <summary
          class="p-6 cursor-pointer text-subtext1 hover:text-text transition-colors flex items-center gap-2"
        >
          <span class="text-lg">ü™ô</span>
          <span>Commodity Holdings</span>
          <span id="commodity-count" class="text-sm text-subtext0 ml-2"
            >(0)</span
          >
        </summary>
        <div class="px-6 pb-6">
          <!-- Add Form -->
          <form id="commodity-form" class="mb-6 p-4 bg-surface1 rounded-lg">
            <h3 class="text-sm font-medium text-subtext1 mb-3">
              Add Commodity Holding
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="block text-xs text-subtext0 mb-1">Type*</label>
                <select
                  name="commodityType"
                  required
                  class="w-full px-3 py-2 bg-surface0 border border-surface2 rounded-lg text-text text-sm"
                >
                  <option value="GOLD">ü•á Gold</option>
                  <option value="SILVER">ü•à Silver</option>
                  <option value="PLATINUM">Platinum</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
              <div>
                <label class="block text-xs text-subtext0 mb-1"
                  >Holding Type</label
                >
                <select
                  name="holdingType"
                  class="w-full px-3 py-2 bg-surface0 border border-surface2 rounded-lg text-text text-sm"
                >
                  <option value="PHYSICAL">Physical</option>
                  <option value="SGB">SGB (Sovereign Gold Bond)</option>
                  <option value="DIGITAL">Digital Gold</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
              <div>
                <label class="block text-xs text-subtext0 mb-1"
                  >Name/Description*</label
                >
                <input
                  type="text"
                  name="name"
                  required
                  placeholder="e.g., Physical Gold 24K"
                  class="w-full px-3 py-2 bg-surface0 border border-surface2 rounded-lg text-text text-sm"
                />
              </div>
              <div>
                <label class="block text-xs text-subtext0 mb-1">Quantity*</label
                >
                <input
                  type="number"
                  name="quantity"
                  step="0.001"
                  required
                  placeholder="e.g., 50"
                  class="w-full px-3 py-2 bg-surface0 border border-surface2 rounded-lg text-text text-sm"
                />
              </div>
              <div>
                <label class="block text-xs text-subtext0 mb-1">Unit</label>
                <select
                  name="unit"
                  class="w-full px-3 py-2 bg-surface0 border border-surface2 rounded-lg text-text text-sm"
                >
                  <option value="GRAM">Grams</option>
                  <option value="KG">Kilograms</option>
                  <option value="OZ">Troy Ounce</option>
                  <option value="UNIT">Units</option>
                </select>
              </div>
              <div>
                <label class="block text-xs text-subtext0 mb-1"
                  >Purchase Price (per unit)*</label
                >
                <input
                  type="number"
                  name="purchasePrice"
                  step="0.01"
                  required
                  placeholder="e.g., 7200"
                  class="w-full px-3 py-2 bg-surface0 border border-surface2 rounded-lg text-text text-sm"
                />
              </div>
              <div>
                <label class="block text-xs text-subtext0 mb-1"
                  >Purchase Date*</label
                >
                <input
                  type="date"
                  name="purchaseDate"
                  required
                  class="w-full px-3 py-2 bg-surface0 border border-surface2 rounded-lg text-text text-sm"
                />
              </div>
              <div class="md:col-span-2">
                <label class="block text-xs text-subtext0 mb-1"
                  >Notes (optional)</label
                >
                <input
                  type="text"
                  name="notes"
                  placeholder="Any notes..."
                  class="w-full px-3 py-2 bg-surface0 border border-surface2 rounded-lg text-text text-sm"
                />
              </div>
            </div>
            <div class="mt-3 flex items-center gap-3">
              <button
                type="submit"
                class="px-4 py-2 bg-yellow hover:bg-yellow/90 text-crust font-medium text-sm rounded-lg transition-colors"
              >
                Add Holding
              </button>
              <span id="commodity-form-status" class="text-sm text-subtext0"
              ></span>
            </div>
          </form>

          <!-- Holdings Table -->
          <div
            id="commodity-holdings-loading"
            class="text-center text-subtext0 py-4"
          >
            Loading commodity holdings...
          </div>
          <table id="commodity-holdings-table" class="w-full hidden">
            <thead
              class="border-b border-surface2 text-left text-sm text-subtext0"
            >
              <tr>
                <th class="pb-2">Holding</th>
                <th class="pb-2 text-right">Quantity</th>
                <th class="pb-2 text-right">Invested</th>
                <th class="pb-2 text-right">Actions</th>
              </tr>
            </thead>
            <tbody
              id="commodity-holdings-body"
              class="divide-y divide-surface2"
            >
            </tbody>
          </table>
          <div
            id="commodity-holdings-empty"
            class="hidden text-center text-subtext0 py-4"
          >
            No commodity holdings yet. Add your first one above!
          </div>
        </div>
      </details>

      <!-- Import Section (Collapsed) -->
      <details class="bg-surface0 border border-surface1 rounded-2xl">
        <summary
          class="p-6 cursor-pointer text-subtext1 hover:text-text transition-colors"
        >
          Import Transactions
        </summary>
        <div class="px-6 pb-6">
          <p class="text-subtext0 text-sm mb-4">
            Upload your Groww Order History and Holdings Statement to sync your
            portfolio.
          </p>

          <form id="import-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-subtext1 mb-1">
                  Order History (Required)
                </label>
                <input
                  type="file"
                  name="orderHistory"
                  accept=".xlsx,.csv"
                  required
                  class="w-full px-4 py-2 bg-surface1 border border-surface2 rounded-lg text-text file:mr-4 file:py-1 file:px-3 file:rounded-lg file:border-0 file:bg-mauve file:text-crust file:font-medium file:cursor-pointer"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-subtext1 mb-1">
                  Holdings Statement (Optional)
                </label>
                <input
                  type="file"
                  name="holdings"
                  accept=".xlsx,.csv"
                  class="w-full px-4 py-2 bg-surface1 border border-surface2 rounded-lg text-text file:mr-4 file:py-1 file:px-3 file:rounded-lg file:border-0 file:bg-surface2 file:text-subtext1 file:font-medium file:cursor-pointer"
                />
              </div>
            </div>

            <button
              type="submit"
              class="px-6 py-2 bg-mauve hover:bg-mauve/90 text-crust font-medium rounded-lg transition-colors"
            >
              Import Transactions
            </button>
          </form>

          <div id="import-status" class="mt-4 hidden">
            <div class="p-4 rounded-lg"></div>
          </div>
        </div>
      </details>

      <!-- Company Notes Modal Container -->
      <div id="company-notes-portal"></div>

      <!-- Research Modal Container -->
      <div id="research-portal"></div>
    </main>
  </div>

  <script>
    // Format currency
    function formatCurrency(value: number): string {
      return new Intl.NumberFormat("en-IN", {
        style: "currency",
        currency: "INR",
        maximumFractionDigits: 0,
      }).format(value);
    }

    // Format decimal currency
    function formatCurrencyDecimal(value: number): string {
      return new Intl.NumberFormat("en-IN", {
        style: "currency",
        currency: "INR",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(value);
    }

    // Load holdings data
    async function loadHoldings() {
      const loadingEl = document.getElementById("holdings-loading")!;
      const tableEl = document.getElementById("holdings-table")!;
      const bodyEl = document.getElementById("holdings-body")!;

      loadingEl.classList.remove("hidden");
      tableEl.classList.add("hidden");

      try {
        const response = await fetch("/api/holdings");
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || "Failed to load holdings");
        }

        // Update summary
        if (data.summary) {
          document.getElementById("holdings-count")!.textContent =
            `(${data.summary.holdings_count})`;
          document.getElementById("current-value")!.textContent =
            formatCurrency(data.summary.current_value);
          document.getElementById("invested-value")!.textContent =
            formatCurrency(data.summary.invested_value);

          const returnsEl = document.getElementById("total-returns")!;
          const isPositive = data.summary.total_returns >= 0;
          returnsEl.textContent = `${isPositive ? "+" : ""}${formatCurrency(data.summary.total_returns)} (${data.summary.total_returns_percent.toFixed(2)}%)`;
          returnsEl.className = `text-xl font-semibold ${isPositive ? "text-green" : "text-red"}`;
        }

        // Update table
        if (data.holdings && data.holdings.length > 0) {
          bodyEl.innerHTML = data.holdings
            .map((h: any) => {
              const isPositive = h.returns >= 0;

              // Build technical badges
              let techBadges = "";

              // RSI badge
              if (h.rsi_14 !== null) {
                const rsiColor =
                  h.rsi_14 > 70
                    ? "bg-red/20 text-red"
                    : h.rsi_14 < 30
                      ? "bg-green/20 text-green"
                      : "bg-surface2 text-subtext0";
                techBadges += `<span class="px-2 py-0.5 text-xs rounded ${rsiColor}">RSI ${h.rsi_14.toFixed(0)}</span>`;
              }

              // SMA50 badge - show % above/below
              if (h.price_vs_sma50 !== null) {
                const isAbove = h.price_vs_sma50 >= 0;
                const sma50Color =
                  h.price_vs_sma50 > 20
                    ? "text-red"
                    : h.price_vs_sma50 < -10
                      ? "text-yellow"
                      : isAbove
                        ? "text-green"
                        : "text-subtext0";
                techBadges += `<span class="px-2 py-0.5 text-xs rounded bg-surface2 ${sma50Color}">${isAbove ? "+" : ""}${h.price_vs_sma50.toFixed(0)}% 50D</span>`;
              }

              // SMA200 badge - show % above/below
              if (h.price_vs_sma200 !== null) {
                const isAbove = h.price_vs_sma200 >= 0;
                const sma200Color =
                  h.price_vs_sma200 > 40
                    ? "text-red"
                    : h.price_vs_sma200 < 0
                      ? "text-yellow"
                      : "text-green";
                techBadges += `<span class="px-2 py-0.5 text-xs rounded bg-surface2 ${sma200Color}">${isAbove ? "+" : ""}${h.price_vs_sma200.toFixed(0)}% 200D</span>`;
              }

              // Wait zone badge
              if (h.is_wait_zone) {
                techBadges += `<span class="px-2 py-0.5 text-xs rounded bg-yellow/20 text-yellow">‚ö†Ô∏è Wait</span>`;
              }

              if (!h.rsi_14 && !h.price_vs_sma50 && !h.is_wait_zone) {
                techBadges = '<span class="text-xs text-subtext0">‚Äî</span>';
              }

              return `
            <tr class="hover:bg-surface1/50 transition-colors">
              <td class="p-4">
                <a href="/company/${encodeURIComponent(h.symbol)}" class="font-medium text-text hover:text-mauve transition-colors underline decoration-dotted hover:decoration-solid">${h.stock_name}</a>
                <div class="text-sm text-subtext0">${h.quantity} shares ‚Ä¢ Avg. ${formatCurrencyDecimal(h.avg_buy_price)}</div>
              </td>
              <td class="p-4 text-center">
                <div class="flex flex-wrap gap-1 justify-center">${techBadges}</div>
                ${h.wait_reasons?.length > 0 ? `<div class="text-xs text-subtext0 mt-1">${h.wait_reasons.join(", ")}</div>` : ""}
              </td>
              <td class="p-4 text-right">
                <div class="text-text">${formatCurrencyDecimal(h.current_price)}</div>
              </td>
              <td class="p-4 text-right">
                <div class="${isPositive ? "text-green" : "text-red"}">${isPositive ? "+" : ""}${formatCurrency(h.returns)}</div>
                <div class="text-sm ${isPositive ? "text-green" : "text-red"}">${h.returns_percent.toFixed(2)}%</div>
              </td>
              <td class="p-4 text-right">
                <div class="text-text font-medium">${formatCurrency(h.current_value)}</div>
                <div class="text-sm text-subtext0">${formatCurrency(h.invested_value)}</div>
              </td>
              <td class="p-4 text-center">
                <div class="flex items-center gap-2 justify-center">
                  <button
                    onclick="showResearch('${h.symbol}')"
                    class="px-3 py-1 text-sm bg-surface1 hover:bg-surface2 text-subtext1 rounded-lg transition-colors"
                    title="Research for ${h.stock_name}"
                  >
                    üìö Research
                  </button>
                  <button
                    onclick="showCompanyNotes('${h.symbol}')"
                    class="px-3 py-1 text-sm bg-surface1 hover:bg-surface2 text-subtext1 rounded-lg transition-colors"
                    title="Notes for ${h.stock_name}"
                  >
                    üìù Notes
                  </button>
                </div>
              </td>
            </tr>
          `;
            })
            .join("");

          loadingEl.classList.add("hidden");
          tableEl.classList.remove("hidden");
        } else {
          loadingEl.textContent =
            "No holdings found. Import your transactions above.";
        }
      } catch (err) {
        loadingEl.textContent =
          err instanceof Error ? err.message : "Failed to load holdings";
      }
    }

    // Initial load
    loadHoldings();
    checkAIAvailability();

    async function checkAIAvailability() {
      try {
        const res = await fetch("/api/settings");
        const { settings } = await res.json();
        const aiEnabled = settings?.ai_enabled !== false;

        const badge = document.getElementById("ai-status-badge");
        const discoveryBtn = document.getElementById("run-discovery-btn");
        const discoverySection = discoveryBtn?.closest("section");
        const aiDisabledMsg = document.getElementById("ai-disabled-message");
        const suggestionsLoading = document.getElementById(
          "suggestions-loading"
        );

        if (!aiEnabled) {
          badge?.classList.remove("hidden");
          if (discoveryBtn) {
            discoveryBtn.classList.add("hidden");
          }
          if (discoverySection) {
            discoverySection.classList.add("opacity-80");
          }
          if (aiDisabledMsg) {
            aiDisabledMsg.classList.remove("hidden");
          }
          if (suggestionsLoading) {
            suggestionsLoading.classList.add("hidden");
          }
        } else {
          badge?.classList.add("hidden");
          discoveryBtn?.classList.remove("hidden");
          discoverySection?.classList.remove("opacity-80");
          aiDisabledMsg?.classList.add("hidden");
          suggestionsLoading?.classList.remove("hidden");
          loadSuggestions();
        }
      } catch (err) {
        console.error("Failed to check AI status:", err);
        loadSuggestions();
      }
    }

    // Refresh button
    document
      .getElementById("refresh-btn")
      ?.addEventListener("click", loadHoldings);

    // Refresh technical data button
    document
      .getElementById("refresh-tech-btn")
      ?.addEventListener("click", async () => {
        const statusEl = document.getElementById("tech-status")!;
        const btn = document.getElementById(
          "refresh-tech-btn"
        ) as HTMLButtonElement;

        btn.disabled = true;
        statusEl.textContent = "Calculating RSI & SMA...";

        try {
          const response = await fetch("/api/technical", { method: "POST" });
          const data = await response.json();

          if (data.success) {
            statusEl.textContent = `‚úì Updated ${data.updated} stocks`;
            setTimeout(() => {
              statusEl.textContent = "";
            }, 3000);
            // Reload holdings to show new badges
            loadHoldings();
          } else {
            statusEl.textContent = `Error: ${data.error}`;
          }
        } catch (err) {
          statusEl.textContent = "Failed to refresh";
        } finally {
          btn.disabled = false;
        }
      });

    // Logout handler
    document
      .getElementById("logout-btn")
      ?.addEventListener("click", async () => {
        await fetch("/api/auth/logout", { method: "POST" });
        window.location.href = "/login";
      });

    // Load suggestions (supports different status filters)
    let currentSuggestionStatus = "pending";

    async function loadSuggestions(status: string = "pending") {
      // Don't load if AI is disabled (handled by checkAIAvailability)
      const aiDisabledMsg = document.getElementById("ai-disabled-message");
      if (aiDisabledMsg && !aiDisabledMsg.classList.contains("hidden")) return;
      const loadingEl = document.getElementById("suggestions-loading")!;
      const listEl = document.getElementById("suggestions-list")!;
      currentSuggestionStatus = status;

      // Update filter button styles
      document.querySelectorAll(".suggestion-filter").forEach((btn) => {
        const btnStatus = btn.getAttribute("data-status");
        if (btnStatus === status) {
          btn.className =
            "suggestion-filter px-2 py-1 text-xs bg-mauve/20 text-mauve rounded transition-colors";
        } else {
          btn.className =
            "suggestion-filter px-2 py-1 text-xs bg-surface2 text-subtext0 hover:bg-surface1 rounded transition-colors";
        }
      });

      try {
        const response = await fetch(`/api/suggestions?status=${status}`);
        const data = await response.json();

        if (data.suggestions && data.suggestions.length > 0) {
          listEl.innerHTML = data.suggestions
            .map((s: any) => {
              let actionColor = "text-subtext0";
              let actionBg = "bg-surface2";
              let actionIcon = "‚Ä¢";
              let details = "";

              if (s.action === "BUY") {
                actionColor = "text-green";
                actionBg = "bg-green/20";
                actionIcon = "BUY";
                details = s.quantity
                  ? `<span class="text-xs text-subtext1 ml-2">Qty: ${s.quantity} (‚Çπ${s.allocation_amount?.toLocaleString()})</span>`
                  : "";
              } else if (s.action === "SELL") {
                actionColor = "text-red";
                actionBg = "bg-red/20";
                actionIcon = "SELL";
                details = s.quantity
                  ? `<span class="text-xs text-subtext1 ml-2">Qty: ${s.quantity}</span>`
                  : "";
              } else if (s.action === "MOVE") {
                actionColor = "text-mauve";
                actionBg = "bg-mauve/20";
                actionIcon = "MOVE";
                details = `<span class="text-xs text-subtext1 ml-2">Sell ${s.sell_quantity} ${s.sell_symbol} ‚Üí Buy ${s.quantity} ${s.symbol}</span>`;
              } else if (s.action === "RAISE_CASH") {
                actionColor = "text-peach";
                actionBg = "bg-peach/20";
                actionIcon = "üíµ CASH";
                details = s.quantity
                  ? `<span class="text-xs text-subtext1 ml-2">Sell ${s.quantity} shares to cash</span>`
                  : `<span class="text-xs text-subtext1 ml-2">Raise cash from position</span>`;
                if (s.cash_deployment_notes) {
                  details += `<span class="text-xs text-peach ml-2">üìù ${s.cash_deployment_notes}</span>`;
                }
              }

              // Confidence badge
              const confidenceBadge = s.confidence
                ? `<span class="px-1.5 py-0.5 text-xs rounded ${s.confidence >= 7 ? "bg-green/20 text-green" : s.confidence >= 4 ? "bg-yellow/20 text-yellow" : "bg-red/20 text-red"}">${s.confidence}/10</span>`
                : s.technical_score
                  ? `<span class="text-xs text-subtext0">Score: ${s.technical_score}</span>`
                  : "";

              // Date display
              const dateStr = s.created_at
                ? new Date(s.created_at).toLocaleDateString()
                : "";

              // Superseded info
              const supersededInfo =
                s.status === "superseded" && s.superseded_reason
                  ? `<div class="text-xs text-yellow mt-1">‚ö†Ô∏è ${s.superseded_reason}${s.superseded_by ? ` ‚Üí Suggestion #${s.superseded_by}` : ""}</div>`
                  : "";

              // Citations display
              let citationsHtml = "";
              if (s.citations && s.citations.length > 0) {
                const citationIcons: Record<string, string> = {
                  research: "üìÑ",
                  link: "üîó",
                  note: "üìù",
                  table: "üìä",
                  valuepickr: "üí¨",
                  news: "üì∞",
                  reddit: "üó£Ô∏è",
                  technicals: "üìà",
                };

                const citationItems = s.citations
                  .map((c: any) => {
                    const icon = citationIcons[c.type] || "üìå";
                    const label = c.title || c.source || c.type;
                    // For user content with IDs, create a link to the company page
                    if (
                      c.id &&
                      ["research", "link", "note", "table"].includes(c.type)
                    ) {
                      return `<a href="/company/${encodeURIComponent(s.symbol)}?tab=${c.type}" class="hover:text-mauve transition-colors">${icon} ${label}</a>`;
                    }
                    return `<span>${icon} ${label}</span>`;
                  })
                  .join(
                    '</span><span class="text-surface2 mx-1">‚Ä¢</span><span>'
                  );

                citationsHtml = `
                  <div class="mt-2 pt-2 border-t border-surface2/50">
                    <div class="flex items-center gap-1 text-xs text-subtext0 flex-wrap">
                      <span class="font-medium text-subtext1">üìö Sources:</span>
                      <span>${citationItems}</span>
                    </div>
                  </div>
                `;
              }

              // Action buttons (only for pending)
              const actionButtons =
                status === "pending"
                  ? `
                <div class="flex gap-2 ml-4">
                  <button class="approve-btn px-3 py-1 text-sm bg-green/20 hover:bg-green/30 text-green rounded transition-colors">
                    ‚úì
                  </button>
                  <button class="reject-btn px-3 py-1 text-sm bg-red/20 hover:bg-red/30 text-red rounded transition-colors">
                    ‚úó
                  </button>
                </div>
              `
                  : `<span class="text-xs text-subtext0 ml-4">${dateStr}</span>`;

              return `
              <div class="bg-surface0 border border-surface1 rounded-lg overflow-hidden mb-2 hover:bg-surface1/50 transition-colors ${status === "superseded" ? "opacity-70" : ""}" data-id="${s.id}" data-suggestion-id="${s.id}">
                <div class="p-4 flex items-center justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="font-medium text-text">${s.stock_name || s.symbol}</span>
                      <span class="px-2 py-0.5 text-xs font-bold rounded ${actionBg} ${actionColor}">${actionIcon}</span>
                      ${confidenceBadge}
                      ${details}
                    </div>
                    <p class="text-sm text-subtext0 mt-1">${s.rationale}</p>
                    ${citationsHtml}
                    ${supersededInfo}
                  </div>
                  ${actionButtons}
                </div>
                <div class="action-notes-container"></div>
              </div>
            `;
            })
            .join("");

          loadingEl.classList.add("hidden");
          listEl.classList.remove("hidden");

          // Mount action notes on the newly created elements
          mountActionNotes();

          // Add click handlers for approve/reject (only for pending)
          if (status === "pending") {
            listEl.querySelectorAll("[data-id]").forEach((el) => {
              const id = el.getAttribute("data-id");
              el.querySelector(".approve-btn")?.addEventListener(
                "click",
                async () => {
                  await updateSuggestion(id!, "approved");
                  el.remove();
                  if (listEl.children.length === 0) {
                    loadingEl.textContent = "No pending suggestions";
                    loadingEl.classList.remove("hidden");
                    listEl.classList.add("hidden");
                  }
                }
              );
              el.querySelector(".reject-btn")?.addEventListener(
                "click",
                async () => {
                  await updateSuggestion(id!, "rejected");
                  el.remove();
                  if (listEl.children.length === 0) {
                    loadingEl.textContent = "No pending suggestions";
                    loadingEl.classList.remove("hidden");
                    listEl.classList.add("hidden");
                  }
                }
              );
            });
          }
        } else {
          const emptyMessage =
            status === "pending"
              ? "No pending suggestions. Run a discovery cycle!"
              : "No suggestion history yet.";
          loadingEl.textContent = emptyMessage;
          listEl.classList.add("hidden");
          loadingEl.classList.remove("hidden");
        }
      } catch (err) {
        console.error("Failed to load suggestions:", err);
      }
    }

    async function updateSuggestion(id: string, status: string) {
      await fetch("/api/suggestions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, status }),
      });
    }

    // Filter button handlers
    document.querySelectorAll(".suggestion-filter").forEach((btn) => {
      btn.addEventListener("click", () => {
        const status = btn.getAttribute("data-status") || "pending";
        loadSuggestions(status);
      });
    });

    // Run Discovery Cycle with Job Queue + SSE
    document
      .getElementById("run-discovery-btn")
      ?.addEventListener("click", async () => {
        const statusEl = document.getElementById("discovery-status")!;
        const btn = document.getElementById(
          "run-discovery-btn"
        ) as HTMLButtonElement;
        const loadingEl = document.getElementById("suggestions-loading")!;
        const progressDiv = document.getElementById("discovery-progress")!;
        const progressBar = document.getElementById("progress-bar")!;
        const progressMsg = document.getElementById("progress-message")!;
        const progressPct = document.getElementById("progress-percent")!;

        btn.disabled = true;
        loadingEl.classList.add("hidden");
        progressDiv.classList.remove("hidden");
        document.getElementById("suggestions-list")!.classList.add("hidden");

        try {
          // Step 1: Create the job
          const createRes = await fetch("/api/jobs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type: "discovery_cycle" }),
          });
          const { job } = await createRes.json();

          if (!job?.id) {
            throw new Error("Failed to create job");
          }

          // Step 2: Connect to SSE for progress updates
          const eventSource = new EventSource(`/api/jobs/${job.id}/status`);

          eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.progress !== undefined) {
              progressBar.style.width = `${data.progress}%`;
              progressPct.textContent = `${data.progress}%`;
            }
            if (data.message) {
              progressMsg.textContent = data.message;
            }

            if (data.status === "completed") {
              eventSource.close();
              progressDiv.classList.add("hidden");
              statusEl.textContent = `‚úì ${data.result?.actionable || 0} actionable suggestions`;
              setTimeout(() => {
                statusEl.textContent = "";
              }, 5000);
              loadSuggestions();
              btn.disabled = false;
            } else if (data.status === "failed") {
              eventSource.close();
              progressDiv.classList.add("hidden");
              statusEl.textContent = `Error: ${data.error}`;
              loadingEl.textContent = data.error || "Discovery failed";
              loadingEl.classList.remove("hidden");
              btn.disabled = false;
            }
          };

          eventSource.onerror = () => {
            eventSource.close();
            progressDiv.classList.add("hidden");
            statusEl.textContent = "Connection lost";
            btn.disabled = false;
          };
        } catch (err) {
          progressDiv.classList.add("hidden");
          statusEl.textContent = "Discovery failed";
          loadingEl.textContent = "Error starting discovery cycle";
          loadingEl.classList.remove("hidden");
          btn.disabled = false;
        }
      });

    // Load existing suggestions on page load
    loadSuggestions();

    // Import form handler
    document
      .getElementById("import-form")
      ?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const formData = new FormData(form);
        const statusEl = document.getElementById("import-status")!;
        const statusDiv = statusEl.querySelector("div")!;

        statusEl.classList.remove("hidden");
        statusDiv.className =
          "p-4 rounded-lg bg-blue/10 border border-blue/30 text-blue";
        statusDiv.textContent = "Importing...";

        try {
          const response = await fetch("/api/import-transactions", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || "Import failed");
          }

          statusDiv.className =
            "p-4 rounded-lg bg-green/10 border border-green/30 text-green";
          statusDiv.innerHTML = `
        <strong>Success!</strong><br>
        Imported ${result.transactionsImported} transactions<br>
        ${result.adjustmentsCreated > 0 ? `Created ${result.adjustmentsCreated} opening balance adjustments` : ""}
      `;

          // Reload holdings after import
          loadHoldings();
        } catch (err) {
          statusDiv.className =
            "p-4 rounded-lg bg-red/10 border border-red/30 text-red";
          statusDiv.textContent =
            err instanceof Error ? err.message : "Import failed";
        }
      });

    // ============================================================
    // Commodity Holdings Management
    // ============================================================

    async function loadCommodityHoldings() {
      const loadingEl = document.getElementById("commodity-holdings-loading")!;
      const tableEl = document.getElementById("commodity-holdings-table")!;
      const bodyEl = document.getElementById("commodity-holdings-body")!;
      const emptyEl = document.getElementById("commodity-holdings-empty")!;
      const countEl = document.getElementById("commodity-count")!;

      try {
        const response = await fetch("/api/commodity-holdings");
        const data = await response.json();

        loadingEl.classList.add("hidden");

        if (data.holdings && data.holdings.length > 0) {
          countEl.textContent = `(${data.holdings.length})`;
          bodyEl.innerHTML = data.holdings
            .map((h: any) => {
              const typeEmoji =
                h.commodityType === "GOLD"
                  ? "ü•á"
                  : h.commodityType === "SILVER"
                    ? "ü•à"
                    : "ü™ô";
              const unitLabel =
                h.unit === "GRAM"
                  ? "g"
                  : h.unit === "KG"
                    ? "kg"
                    : h.unit === "OZ"
                      ? "oz"
                      : "";
              return `
                <tr class="hover:bg-surface1/50" data-id="${h.id}">
                  <td class="py-3">
                    <div class="font-medium text-text">${typeEmoji} ${h.name}</div>
                    <div class="text-xs text-subtext0">${h.holdingType} ‚Ä¢ ${new Date(h.purchaseDate).toLocaleDateString()}</div>
                  </td>
                  <td class="py-3 text-right text-text">${h.quantity} ${unitLabel}</td>
                  <td class="py-3 text-right">
                    <div class="text-text">${formatCurrency(h.investedValue)}</div>
                    <div class="text-xs text-subtext0">@ ${formatCurrencyDecimal(h.purchasePrice)}/${unitLabel}</div>
                  </td>
                  <td class="py-3 text-right">
                    <button class="delete-commodity-btn px-2 py-1 text-xs bg-red/20 hover:bg-red/30 text-red rounded transition-colors">
                      Delete
                    </button>
                  </td>
                </tr>
              `;
            })
            .join("");

          tableEl.classList.remove("hidden");
          emptyEl.classList.add("hidden");

          // Add delete handlers
          bodyEl.querySelectorAll(".delete-commodity-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              const row = (e.target as HTMLElement).closest("tr")!;
              const id = row.getAttribute("data-id");
              if (confirm("Delete this commodity holding?")) {
                await fetch(`/api/commodity-holdings?id=${id}`, {
                  method: "DELETE",
                });
                row.remove();
                const remaining = bodyEl.querySelectorAll("tr").length;
                countEl.textContent = `(${remaining})`;
                if (remaining === 0) {
                  tableEl.classList.add("hidden");
                  emptyEl.classList.remove("hidden");
                }
              }
            });
          });
        } else {
          countEl.textContent = "(0)";
          tableEl.classList.add("hidden");
          emptyEl.classList.remove("hidden");
        }
      } catch (err) {
        loadingEl.textContent = "Failed to load commodity holdings";
      }
    }

    // Commodity form submission
    document
      .getElementById("commodity-form")
      ?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const formData = new FormData(form);
        const statusEl = document.getElementById("commodity-form-status")!;

        const payload = {
          commodityType: formData.get("commodityType"),
          holdingType: formData.get("holdingType"),
          name: formData.get("name"),
          quantity: parseFloat(formData.get("quantity") as string),
          unit: formData.get("unit"),
          purchasePrice: parseFloat(formData.get("purchasePrice") as string),
          purchaseDate: formData.get("purchaseDate"),
          notes: formData.get("notes") || undefined,
        };

        statusEl.textContent = "Adding...";

        try {
          const response = await fetch("/api/commodity-holdings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || "Failed to add");
          }

          statusEl.textContent = "‚úì Added!";
          form.reset();
          loadCommodityHoldings();

          setTimeout(() => {
            statusEl.textContent = "";
          }, 2000);
        } catch (err) {
          statusEl.textContent = err instanceof Error ? err.message : "Failed";
        }
      });

    // Load commodity holdings on page load
    loadCommodityHoldings();

    // ============================================================
    // SolidJS Components Integration - Notes Feature
    // ============================================================

    // Import SolidJS render function
    import { render } from "solid-js/web";
    import ActionNotes from "../components/notes/ActionNotes";
    import CompanyNotes from "../components/notes/CompanyNotes";
    import ResearchList from "../components/research/ResearchList";

    // State for company notes modal
    let companyNotesCleanup: (() => void) | null = null;
    let currentSymbol: string | null = null;

    // Function to show company notes modal
    function showCompanyNotes(symbol: string) {
      const portal = document.getElementById("company-notes-portal");
      if (!portal) return;

      // Clean up previous instance if exists
      if (companyNotesCleanup) {
        companyNotesCleanup();
      }

      currentSymbol = symbol;

      // Render CompanyNotes component
      companyNotesCleanup = render(
        () =>
          CompanyNotes({
            symbol,
            onClose: () => {
              if (companyNotesCleanup) {
                companyNotesCleanup();
                companyNotesCleanup = null;
                currentSymbol = null;
              }
            },
          }),
        portal
      );
    }

    // Make function globally available for inline event handlers
    (window as any).showCompanyNotes = showCompanyNotes;

    // Function to show research modal
    let researchCleanup: any = null;

    function showResearch(symbol: string) {
      const portal = document.getElementById("research-portal");
      if (!portal) return;

      // Clean up previous instance if exists
      if (researchCleanup) {
        researchCleanup();
      }

      // Render ResearchList component
      researchCleanup = render(
        () =>
          ResearchList({
            symbol,
            onClose: () => {
              if (researchCleanup) {
                researchCleanup();
                researchCleanup = null;
              }
            },
          }),
        portal
      );
    }

    // Make function globally available for inline event handlers
    (window as any).showResearch = showResearch;

    // Function to mount ActionNotes components after suggestions are loaded
    function mountActionNotes() {
      const suggestionCards = document.querySelectorAll("[data-suggestion-id]");

      suggestionCards.forEach((card) => {
        const suggestionId = card.getAttribute("data-suggestion-id");
        const notesContainer = card.querySelector(".action-notes-container");

        if (notesContainer && suggestionId) {
          render(() => ActionNotes({ suggestionId }), notesContainer);
        }
      });
    }

    // Enhance loadSuggestions with ActionNotes mounting
    const _loadSuggestions = loadSuggestions;
    window.addEventListener("DOMContentLoaded", () => {
      // Override calls to loadSuggestions throughout the page
      const originalCall = loadSuggestions.bind(window);
      (window as any).loadSuggestionsOriginal = originalCall;
    });

    // Call mountActionNotes after initial load
    loadSuggestions().then(() => {
      setTimeout(mountActionNotes, 100);
    });

    // Intercept filter button clicks to mount notes
    document.querySelectorAll(".suggestion-filter").forEach((btn) => {
      btn.addEventListener("click", () => {
        setTimeout(mountActionNotes, 200);
      });
    });

    // Intercept discovery button to mount notes after completion
    const discoveryBtn = document.getElementById("run-discovery-btn");
    if (discoveryBtn) {
      discoveryBtn.addEventListener("click", () => {
        // Listen for suggestions to be loaded
        const observer = new MutationObserver((mutations) => {
          const listEl = document.getElementById("suggestions-list");
          if (listEl && !listEl.classList.contains("hidden")) {
            setTimeout(mountActionNotes, 200);
            observer.disconnect();
          }
        });

        observer.observe(document.getElementById("suggestions-list")!, {
          attributes: true,
          attributeFilter: ["class"],
        });
      });
    }
  </script>
</Layout>
